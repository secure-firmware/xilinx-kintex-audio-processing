### **Time-Stretching Module**

Now that we have the noise-reduced magnitude and phase, the next step is to implement the **Time-Stretching Module**. This module will adjust the phase and interpolate the magnitude for time-stretching.

The key idea here is to modify the phase and magnitude based on the time-stretching factor. In a phase vocoder, the phase is adjusted to ensure smooth transitions between frames, while the magnitude is interpolated to maintain the perceived quality of the audio.

#### **Core Concepts**:
1. **Phase Adjustment**: The phase is adjusted to preserve pitch during time-stretching. The delta phase between successive frames is maintained.
2. **Magnitude Interpolation**: Magnitude values are interpolated to handle time-stretching across multiple frames.
3. **Time-Stretching Factor**: The factor controls how much slower or faster the audio should be (e.g., 1.5 for 50% slower).

---

#### **Time-Stretching (Verilog)**

```verilog
module time_stretching (
    input clk,
    input rst,
    input valid_in,
    input [31:0] magnitude_in,  // Magnitude from the noise-reduction module
    input [15:0] phase_in,      // Phase from the phase extraction module
    input [15:0] prev_phase,    // Phase from the previous frame
    input [31:0] time_stretch_factor,  // Time stretch factor (fixed-point format, e.g., 1.5x)
    output reg [31:0] stretched_magnitude,  // Stretched magnitude output
    output reg [15:0] adjusted_phase,  // Adjusted phase for time-stretching
    output reg valid_out
);

    reg [15:0] delta_phase;  // Phase difference between successive frames

    // Compute delta phase: delta_phase = phase_in - prev_phase
    always @(posedge clk or posedge rst) begin
        if (rst) begin
            delta_phase <= 16'd0;
            adjusted_phase <= 16'd0;
        end else if (valid_in) begin
            delta_phase <= phase_in - prev_phase;
            // Phase unwrapping (modulus 2Ï€, in radians)
            if (delta_phase < -16'd32768) begin
                delta_phase <= delta_phase + 16'd65536;
            end else if (delta_phase > 16'd32768) begin
                delta_phase <= delta_phase - 16'd65536;
            end

            // Adjust phase based on time-stretching factor: adjusted_phase = prev_phase + delta_phase * time_stretch_factor
            adjusted_phase <= prev_phase + delta_phase * time_stretch_factor[15:0];
        end
    end

    // Interpolate magnitude (for simplicity, assume linear interpolation)
    always @(posedge clk or posedge rst) begin
        if (rst) begin
            stretched_magnitude <= 32'd0;
        end else if (valid_in) begin
            // Simple magnitude interpolation (linear)
            stretched_magnitude <= magnitude_in * time_stretch_factor[15:0];  // Stretch magnitude by the factor
        end
    end

    // Valid output signal
    always @(posedge clk or posedge rst) begin
        if (rst) begin
            valid_out <= 1'b0;
        end else begin
            valid_out <= valid_in;
        end
    end

endmodule
```

### **Explanation**:
1. **Phase Adjustment**:
   - The phase difference (`delta_phase`) between successive frames is computed.
   - The phase is "unwrapped" to ensure continuity across frames, and it is adjusted according to the time-stretching factor.
   - The time-stretched phase is computed as:  
     \( \text{adjusted phase} = \text{previous phase} + (\text{delta phase} \times \text{time stretch factor}) \)
   
2. **Magnitude Interpolation**:
   - The magnitude is interpolated using a simple linear scaling based on the time-stretching factor.
   - This ensures that the perceived intensity of the sound remains consistent during time-stretching.

3. **Time-Stretching Factor**:
   - This input controls the rate at which the audio is slowed down or sped up. For example, a factor of 1.5 would slow down the audio by 50%.

---

### **Step 12: Testbench for Time-Stretching**

Let's write a testbench to verify the time-stretching module.

#### **Testbench for Time-Stretching**:

```verilog
module tb_time_stretching();

    reg clk;
    reg rst;
    reg valid_in;
    reg [31:0] magnitude_in;
    reg [15:0] phase_in;
    reg [15:0] prev_phase;
    reg [31:0] time_stretch_factor;
    wire [31:0] stretched_magnitude;
    wire [15:0] adjusted_phase;
    wire valid_out;

    // Instantiate the time-stretching module
    time_stretching uut (
        .clk(clk),
        .rst(rst),
        .valid_in(valid_in),
        .magnitude_in(magnitude_in),
        .phase_in(phase_in),
        .prev_phase(prev_phase),
        .time_stretch_factor(time_stretch_factor),
        .stretched_magnitude(stretched_magnitude),
        .adjusted_phase(adjusted_phase),
        .valid_out(valid_out)
    );

    // Clock generation (100 MHz)
    always begin
        #5 clk = ~clk;
    end

    // Test scenario
    initial begin
        // Initialize
        clk = 0;
        rst = 1;
        valid_in = 0;
        magnitude_in = 32'd0;
        phase_in = 16'd0;
        prev_phase = 16'd0;
        time_stretch_factor = 32'd65536;  // 1.0x (no stretch initially)
        
        // Release reset
        #10 rst = 0;

        // Apply test magnitudes and phases
        #10 valid_in = 1;
        magnitude_in = 32'd1000;  // Test input magnitude
        phase_in = 16'd30000;  // Test input phase
        prev_phase = 16'd29000;  // Previous frame's phase
        time_stretch_factor = 32'd98304;  // Stretch by 1.5x

        #10 valid_in = 1;
        magnitude_in = 32'd1200;  // Test input magnitude
        phase_in = 16'd31000;
        prev_phase = 16'd30000;
        time_stretch_factor = 32'd98304;  // Stretch by 1.5x
        
        // Check the outputs
        #50;
        $stop;
    end
endmodule
```

#### **Explanation**:
- The testbench feeds test magnitudes and phases into the `time_stretching` module and checks if the time-stretched magnitude and adjusted phase are computed correctly.
- We also adjust the `time_stretch_factor` to test how the stretching factor affects the output.
- The clock is generated with a 10ns period (100 MHz), and reset is released after 10 cycles.

---

#### Synthesize and Simulate**

1. **Synthesize** the time-stretching module in Vivado.
2. **Simulate** the testbench:
   - Verify that the phase adjustment is working correctly and that the phase is unwrapped properly.
   - Check if the magnitude is being stretched correctly based on the time-stretch factor.
   - Ensure that the `valid_out` signal is synchronized with the input signals.
